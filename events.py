"""
Docstring for events

Voice Agent Event Types

This module defines typed dataclasses for all events that flow through the voice
agent pipeline, including STT events, TTS events, and ASR events.
"""


import base64
import dataclasses
import time
from dataclasses import dataclass
from typing import Literal, Union

def _now_ms() -> int:
    "returns current unix timestamp in milliseconds"
    return int(time.time() * 1000)


@dataclass
class UserSpeechEvent:
    """Event representing user speech input"""
    audio_data: bytes # raw PCM audio data
    type: Literal['user_speech'] = 'user_speech'  
    timestamp: int = _now_ms()  # event timestamp in ms


@dataclass
class STTChunkEvent:
    """Event representing a partial STT transcription"""
    text: str  # partial transcription text
    type: Literal['stt_chunk'] = 'stt_chunk'
    is_final: bool = False  # whether this is a final chunk
    timestamp: int = _now_ms()  # event timestamp in ms


@dataclass
class STTOutputEvent:
    """Event representing a final STT transcription"""
    text: str  # final transcription text
    type: Literal['stt_output'] = 'stt_output'
    timestamp: int = _now_ms()  # event timestamp in ms


STTEvent = Union[STTChunkEvent, STTOutputEvent]

@dataclass
class AgentChunkEvent:
    """
    Event emitted during agent response generation for streaming text chunks.

    As the LLM generates its response, it streams tokens incrementally.
    These chunks enable real-time display of the agent's response and allow
    the TTS stage to begin synthesis before the complete response is generated,
    reducing overall latency.
    """

    text: str  # text chunk generated by the agent
    type: Literal['agent_chunk'] = 'agent_chunk'
    timestamp: int = _now_ms()  # event timestamp in ms


@dataclass
class AgentEndEvent:
    """Event indicating the agent has completed its response generation"""
    type: Literal['agent_end'] = 'agent_end'
    text: str = ""  # optional final text (can be empty)
    timestamp: int = _now_ms()  # event timestamp in ms


@dataclass
class ToolCallEvent:
    """
    Event representing a tool call made by the agent.
    """
    id: str  # unique ID for the tool call
    tool_name: str  # name of the tool being called
    arguments: dict  # arguments passed to the tool
    type: Literal['tool_call'] = 'tool_call'
    timestamp: int = _now_ms()  # event timestamp in ms

@dataclass
class ToolReturnEvent:
    """
    Event representing the return value from a tool call.
    """

    id: str  # unique ID for the tool call
    tool_name: str  # name of the tool
    return_value: str  # return value from the tool
    type: Literal['tool_return'] = 'tool_return'
    timestamp: int = _now_ms()  # event timestamp in ms


# union of all agent events
AgentEvent = Union[AgentChunkEvent, AgentEndEvent, ToolCallEvent, ToolReturnEvent]


@dataclass
class TTSChunkEvent:
    """Event representing a chunk of TTS audio data"""
    audio_data: bytes  # raw PCM audio data
    type: Literal['tts_chunk'] = 'tts_chunk'
    is_final: bool = False  # whether this is the final chunk
    timestamp: int = _now_ms()  # event timestamp in ms


VoiceAgentEvent = Union[UserSpeechEvent, STTEvent, AgentEvent, TTSChunkEvent]

def event_to_dict(event: VoiceAgentEvent) -> dict:
    """Convert a VoiceAgentEvent to a JSON-serializable dict"""
    if isinstance(event, UserSpeechEvent):
        return {
            "type": event.type,
            "audio_data": base64.b64encode(event.audio_data).decode('utf-8'),
            "timestamp": event.timestamp
        }
    elif isinstance(event, STTChunkEvent):
        return {
            "type": event.type,
            "text": event.text,
            "is_final": event.is_final,
            "timestamp": event.timestamp
        }
    elif isinstance(event, STTOutputEvent):
        return {
            "type": event.type,
            "text": event.text,
            "timestamp": event.timestamp
        }
    elif isinstance(event, AgentChunkEvent):
        return {
            "type": event.type,
            "text": event.text,
            "timestamp": event.timestamp
        }
    elif isinstance(event, AgentEndEvent):
        return {
            "type": event.type,
            "text": event.text,
            "timestamp": event.timestamp
        }
    elif isinstance(event, ToolCallEvent):
        return {
            "type": event.type,
            "id": event.id,
            "tool_name": event.tool_name,
            "arguments": event.arguments,
            "timestamp": event.timestamp
        }
    elif isinstance(event, ToolReturnEvent):
        return {
            "type": event.type,
            "id": event.id,
            "tool_name": event.tool_name,
            "return_value": event.return_value,
            "timestamp": event.timestamp
        }
    elif isinstance(event, TTSChunkEvent):
        return {
            "type": event.type,
            "audio_data": base64.b64encode(event.audio_data).decode('utf-8'),
            "is_final": event.is_final,
            "timestamp": event.timestamp
        }
    else:
        raise ValueError(f"Unknown event type: {type(event)}")